/*********************************************************************************
     * By installing or using this file, you are confirming on behalf of the entity
     * subscribed to the SugarCRM Inc. product ("Company") that Company is bound by
     * the SugarCRM Inc. Master Subscription Agreement (“MSA”), which is viewable at:
     * http://www.sugarcrm.com/master-subscription-agreement
     *
     * If Company is not bound by the MSA, then by installing or using this file
     * you are agreeing unconditionally that Company will be bound by the MSA and
     * certifying that you have authority to bind Company accordingly.
     *
     * Copyright (C) 2004-2013 SugarCRM Inc.  All rights reserved.
     ********************************************************************************/
({events:{'click .toggle-link':'handleToggleClick'},initialize:function(options){options.meta.buttons=this.getButtons(options);app.view.View.prototype.initialize.call(this,options);this.layout.on('toggle:change',this.handleToggleChange,this);this.layout.on('lead:convert-dupecheck:pending',this.setDupeCheckPending,this);this.layout.on('lead:convert-dupecheck:complete',this.setDupeCheckResults,this);this.layout.on('lead:convert-panel:complete',this.handlePanelComplete,this);this.layout.on('lead:convert-panel:reset',this.handlePanelReset,this);this.layout.on('lead:convert:duplicate-selection:change',this.setAssociateButtonState,this);this.context.on('lead:convert:'+this.meta.module+':shown',this.handlePanelShown,this);this.context.on('lead:convert:'+this.meta.module+':hidden',this.handlePanelHidden,this);this.initializeSubTemplates();},getButtons:function(options){return[{name:'associate_button',type:'button',label:this.getLabel('LBL_CONVERT_ASSOCIATE_MODULE',{'moduleName':options.meta.moduleSingular}),css_class:'btn-primary disabled'},{name:'reset_button',type:'button',label:'LBL_CONVERT_RESET_PANEL',css_class:'btn-invisible btn-link'}];},_render:function(){app.view.View.prototype._render.call(this);this.getField('reset_button').hide();},getCurrentState:function(){var currentState=_.extend({},this.layout.currentState,{create:(this.layout.currentToggle===this.layout.TOGGLE_CREATE),labelModule:this.module,moduleInfo:{'moduleName':this.meta.moduleSingular},required:this.meta.required});if(_.isNumber(currentState.dupeCount)){currentState.duplicateCheckResult={'duplicateCount':currentState.dupeCount};}
return currentState;},initializeSubTemplates:function(){this.tpls={};this.initial={};this.tpls.title=app.template.getView(this.name+'.title',this.module);this.initial.title=this.tpls.title(this.getCurrentState());this.tpls.dupecheckPending=app.template.getView(this.name+'.dupecheck-pending',this.module);this.tpls.dupecheckResults=app.template.getView(this.name+'.dupecheck-results',this.module);},handleToggleClick:function(event){var nextToggle=this.$(event.target).data('next-toggle');this.layout.trigger('toggle:showcomponent',nextToggle);event.stopPropagation();},handleToggleChange:function(toggle){this.renderTitle();this.toggleDupeCheckResults(toggle===this.layout.TOGGLE_DUPECHECK);this.setSubViewToggle(toggle);this.setAssociateButtonState();},handlePanelShown:function(){this.$('.accordion-heading').addClass('active');this.toggleSubViewToggle(true);this.setAssociateButtonState();this.toggleActiveIndicator(true);},handlePanelHidden:function(){this.$('.accordion-heading').removeClass('active');this.toggleSubViewToggle(false);this.setAssociateButtonState(false);this.toggleActiveIndicator(false);},handlePanelComplete:function(){this.setStepCircle(true);this.renderTitle();this.toggleDupeCheckResults(false);this.toggleSubViewToggle(false);this.toggleButtons(true);},handlePanelReset:function(){this.setStepCircle(false);this.renderTitle();this.toggleDupeCheckResults(true);this.toggleButtons(false);this.setAssociateButtonState();},setStepCircle:function(complete){var $stepCircle=this.$('.step-circle');if(complete){$stepCircle.addClass('complete');}else{$stepCircle.removeClass('complete');}},renderTitle:function(){this.$('.title').html(this.tpls.title(this.getCurrentState()));},setDupeCheckPending:function(){this.renderDupeCheckResults('pending');},setDupeCheckResults:function(duplicateCount){if(duplicateCount>0){this.renderDupeCheckResults('results');}else{this.renderDupeCheckResults('clear');this.toggleSubViewLink('dupecheck',false);this.toggleSubViewLink('create',false);}},renderDupeCheckResults:function(type){var results='';if(type==='results'){results=this.tpls.dupecheckResults(this.getCurrentState());}else if(type==='pending'){results=this.tpls.dupecheckPending(this.getCurrentState())}
this.$('.dupecheck-results').text(results);},toggleDupeCheckResults:function(show){this.$('.dupecheck-results').toggle(show);},toggleSubViewToggle:function(show){if(this.layout.currentState.complete){show=false}
this.$('.subview-toggle').toggleClass('hide',!show);},setSubViewToggle:function(nextToggle){_.each(['dupecheck','create'],function(currentToggle){this.toggleSubViewLink(currentToggle,(nextToggle===currentToggle));},this);},toggleSubViewLink:function(currentToggle,show){this.$('.subview-toggle .'+currentToggle).toggle(show);},toggleButtons:function(complete){var associateButton='associate_button',resetButton='reset_button'
if(complete){this.getField(associateButton).hide();this.getField(resetButton).show();}else{this.getField(associateButton).show();this.getField(resetButton).hide();}},setAssociateButtonState:function(activate){var $associateButton=this.$('[name="associate_button"]'),panelActive=this.$('.accordion-heading').hasClass('active');if(_.isUndefined(activate)){if(this.layout.currentToggle===this.layout.TOGGLE_CREATE){activate=true;}else{activate=this.layout.currentState.dupeSelected;}}
if(activate&&panelActive){$associateButton.removeClass('disabled');}else{$associateButton.addClass('disabled');}},toggleActiveIndicator:function(active){var $activeIndicator=this.$('.active-indicator i');$activeIndicator.toggleClass('icon-chevron-up',active);$activeIndicator.toggleClass('icon-chevron-down',!active);},getLabel:function(key,context){return app.lang.get(key,'Leads',context);}})